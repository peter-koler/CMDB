# 功能规格说明书：CMDB CI 关系触发器优化

**功能分支**: `005-ci-relation-trigger`  
**创建日期**: 2026-02-20  
**状态**: 草稿  
**输入**: 用户描述: "我需要优化系统里面的模型关系触发器功能，实现新增 cmdb  ci 时能根据触发器自动生成关系，支持配置是否有后台批量扫描该模型的不满足的 ci 数据然后自动建立关系。要求所有文档使用中文输出，代码简洁，避免过度设计"

## 澄清记录

### 会话 2026-02-20

- Q: 触发器规则中源属性和目标属性的匹配方式是什么？ → A: 精确值匹配，简单可靠
- Q: 当用户更新现有 CI 的属性值时，是否也需要触发关系创建？ → A: 是，更新 CI 时也触发关系创建
- Q: 后台批量扫描任务如何触发执行？ → A: 支持定时自动执行 + 管理员手动触发
- Q: 当触发器规则匹配到已存在的关系时，如何处理？ → A: 检测并跳过已存在的关系，避免重复
- Q: 当一个 CI 同时匹配多个触发器规则时，如何处理执行顺序？ → A: 并行执行所有匹配的规则
- Q: 是否需要页面查看批量扫描执行历史？ → A: 是，需要页面展示执行时间、结果和统计
- Q: 批量扫描执行计划如何配置？ → A: 支持 Cron 表达式配置执行时间点
- Q: 定时任务调度框架选择？ → A: 使用 APScheduler

## 用户场景与测试 *(必填)*

### 用户场景 1 - 新增或更新 CI 时自动建立关系 (优先级: P1)

当用户新增或更新一个配置项（CI）时，系统根据该 CI 所属模型配置的关系触发器规则，自动创建符合条件的关系。

**优先级原因**: 这是核心功能，用户最直接的价值诉求，无需人工干预即可自动建立关系。

**独立测试**: 通过创建一个新的 CI，验证系统是否根据触发器规则自动建立相应的关系，无需其他操作即可看到关系被创建。

**验收场景**:

1. **给定** 用户已配置好模型的关系触发器规则，**当** 用户新增或更新一个 CI，**那么** 系统自动创建符合规则的关系
2. **给定** 用户新增或更新的 CI 不满足任何触发器条件，**当** 保存 CI，**那么** 不创建任何关系
3. **给定** 触发器规则指定了源模型和目标模型，**当** 新增或更新的 CI 属于源模型，**那么** 系统自动匹配目标模型中符合条件的 CI 并建立关系

---

### 用户场景 2 - 配置后台批量扫描 (优先级: P2)

管理员可以针对每个模型配置是否启用后台批量扫描任务，支持定时自动执行和手动触发，用于定期检测不满足关系条件的 CI 数据并自动建立关系。

**优先级原因**: 补充功能，用于处理历史数据和增量同步，确保数据一致性，属于自动化运维能力。

**独立测试**: 通过配置模型的批量扫描开关并手动触发扫描，验证系统是否扫描并创建缺失的关系。

**验收场景**:

1. **给定** 管理员为模型启用了批量扫描功能，**当** 定时任务执行或管理员手动触发时，**那么** 系统扫描该模型所有 CI 并建立符合触发器规则的关系
2. **给定** 管理员为模型禁用了批量扫描功能，**当** 后台任务执行时，**那么** 系统跳过该模型，不进行扫描
3. **给定** 批量扫描正在执行，**当** 管理员再次触发扫描，**那么** 系统应该支持并发或排队处理

---

### 用户场景 3 - 查看关系触发器配置 (优先级: P3)

管理员可以查看模型的关系触发器配置，包括触发条件、目标模型、关系类型等信息。

**优先级原因**: 配置管理的基础能力，用于运维监控和调试。

**验收场景**:

1. **给定** 管理员进入模型配置页面，**当** 查看关系触发器配置，**那么** 显示该模型所有触发器规则的列表

---

### 用户场景 4 - 查看批量扫描执行历史 (优先级: P3)

管理员可以在页面上查看后台批量扫描任务的执行历史，包括执行时间、执行结果、处理数量等信息。

**优先级原因**: 运维监控能力，帮助管理员了解批量扫描的运行状态和效果。

**独立测试**: 通过访问批量扫描历史页面，验证是否能展示任务的执行时间、状态和统计信息。

**验收场景**:

1. **给定** 管理员进入批量扫描历史页面，**当** 页面加载完成，**那么** 显示所有模型的扫描任务执行记录
2. **给定** 管理员查看某个扫描任务详情，**当** 点击任务记录，**那么** 显示该任务的执行时间、处理 CI 数量、创建关系数量等信息
3. **给定** 扫描任务失败，**当** 管理员查看任务详情，**那么** 显示失败原因和错误信息

---

### 用户场景 5 - 配置批量扫描执行计划 (优先级: P3)

管理员可以为每个模型配置批量扫描的执行计划，包括执行时间点（Cron 表达式）、是否启用等。

**优先级原因**: 灵活配置能力，满足不同业务场景的扫描需求。

**独立测试**: 通过配置模型的批量扫描计划，验证定时任务是否按配置的时间执行。

**验收场景**:

1. **给定** 管理员进入模型配置页面，**当** 配置批量扫描计划为每天凌晨 2 点执行，**那么** 系统在每天凌晨 2 点自动触发扫描
2. **给定** 管理员修改执行计划，**当** 保存配置，**那么** 新的执行计划立即生效
3. **给定** 管理员禁用批量扫描，**当** 保存配置，**那么** 定时任务不再执行

---

### 边界情况

- 当触发器规则配置错误导致无法匹配目标 CI 时，系统应记录错误日志并跳过
- 当批量扫描的数据量非常大时，系统应支持分批处理避免超时
- 当目标模型被删除时，相关的触发器规则应自动失效
- 当触发器匹配到已存在的关系时，系统应跳过创建，避免重复关系
- 当一个 CI 同时匹配多个触发器规则时，系统应并行执行所有匹配的规则

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须支持为模型配置关系触发器规则，包括源属性、目标模型、目标属性、关系类型
- **FR-002**: 当新增或更新 CI 时，系统必须自动根据触发器规则创建符合条件的关系
- **FR-003**: 系统必须支持在模型配置中启用或禁用后台批量扫描功能，支持定时自动执行和管理员手动触发
- **FR-004**: 当启用批量扫描时，系统必须定期扫描该模型的 CI 数据并自动建立缺失的关系
- **FR-005**: 系统必须提供触发器规则的查看和编辑功能
- **FR-006**: 系统必须记录触发器执行日志，包括成功创建的关系和失败的原因
- **FR-007**: 系统必须提供批量扫描执行历史页面，展示任务的执行时间、状态、处理数量等信息
- **FR-008**: 系统必须支持通过 Cron 表达式配置批量扫描的执行计划
- **FR-009**: 系统必须支持查看单个扫描任务的详细执行结果

### 关键实体

- **关系触发器**: 定义 CI 关系生成的规则，包含源模型、源属性、目标模型、目标属性、关系类型；匹配方式为精确值匹配
- **CI 关系**: 表示两个 CI 之间的关系实例，包含关系类型和关联的源 CI 与目标 CI
- **模型配置**: 包含模型的基本信息、是否启用批量扫描的开关、执行计划（Cron 表达式）
- **批量扫描任务**: 记录每次批量扫描的执行信息，包含任务状态、执行时间、处理数量、创建关系数量、错误信息等
- **触发器执行日志**: 记录单次触发器执行的详细信息，包含源 CI、目标 CI、执行状态、执行消息

## 成功标准 *(必填)*

### 可衡量成果

- **SC-001**: 新增 CI 后，符合触发器条件的关系在 5 秒内自动创建完成
- **SC-002**: 批量扫描任务能够处理至少 10,000 个 CI 而不出现超时
- **SC-003**: 90% 的触发器规则执行成功并正确建立关系
- **SC-004**: 管理员可以在模型配置页面查看和管理触发器规则配置，页面加载时间 < 2 秒，完成配置操作 < 3 次点击
- **SC-005**: 管理员可以在批量扫描历史页面查看所有任务的执行时间和结果
- **SC-006**: Cron 表达式配置变更后，新的执行计划在 1 分钟内生效
