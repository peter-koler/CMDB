# CMDB 关系管理全维度能力规约 v4.0 (Comprehensive Edition)

## 1. 核心愿景与能力边界
本规约旨在构建一个**自愈、实时、可信**的 CMDB 关系图谱系统。它不仅是静态数据的存储，更是动态架构的感知引擎。

### 1.1 核心能力矩阵
| 能力领域 | 关键特性 | 业务价值 |
| :--- | :--- | :--- |
| **定义能力** | 语义化、方向性、强约束、基数限制 | 防止脏数据，确保图谱逻辑正确 |
| **感知能力** | 引用同步、规则推导、API 注入、Agent 采集 | 降低人工维护成本，提升实时性 |
| **治理能力** | 孤岛检测、环路检测、冲突仲裁、级联保护 | 提升数据质量，保障系统稳定性 |
| **洞察能力** | 依赖分析、影响传播、根因回溯、架构分层 | 辅助故障定位与架构优化 |

---

## 2. 深度业务逻辑规范

### 2.1 关系定义的严格约束 (Strict Constraints)
为了避免“全网互联”的混乱图谱，必须在模型层实施严格管控。
*   **模型对白名单 (Model Pair Whitelist)**:
    *   *规则*: 明确规定 `SourceModel` -> `RelationType` -> `TargetModel` 的合法路径。
    *   *示例*: 允许 `App` -> `runs_on` -> `Host`，**禁止** `App` -> `runs_on` -> `Switch`。
*   **基数强制 (Cardinality Enforcement)**:
    *   `1:1`: 网口 (Port) -> 网线 (Cable)。系统需防止多条线插同一个口。
    *   `1:N`: 宿主机 (Host) -> 虚拟机 (VM)。
    *   `N:N`: 应用 (App) -> 数据库 (DB)。
*   **自环与互环限制**:
    *   是否允许自环？(如：依赖自身) -> 默认禁止。
    *   是否允许 A->B->A？(逻辑依赖允许，物理包含禁止)。

### 2.2 自动化构建的深层逻辑 (Deep Automation)

#### A. 引用属性同步 (Reference Sync) - **SSOT 核心**
*   **逻辑**: 属性 (Field) 是源，关系 (Relation) 是影。
*   **异常处理**:
    *   *非法引用*: 如果 `host_id` 指向了一个不存在的 Host ID，系统应如何处理？ -> **拒绝写入** 或 **标记为悬空 (Dangling)** 并告警。
    *   *类型不匹配*: 如果 `host_id` 指向了一个 `Switch` 而不是 `Host`？ -> **拒绝写入**。

#### B. 规则引擎推导 (Rule Inference) - **智能补全**
*   **触发机制**:
    *   *实时 (Real-time)*: 针对轻量级规则 (如 IP 匹配)。
    *   *T+1 (Batch)*: 针对全量扫描规则 (如“孤岛节点发现”)。
*   **冲突仲裁 (Arbitration)**:
    *   场景: 规则 A 推导出关系 R1，规则 B 推导出关系 R2，且 R1 与 R2 互斥 (如基数限制)。
    *   策略: 基于 **优先级 (Priority)** 字段裁决，高优先级规则胜出。

### 2.3 关系生命周期与数据治理 (Lifecycle & Governance)

#### A. 变更传播 (Change Propagation)
*   **CI 删除**:
    *   *作为源*: 级联删除所有发出的关系。
    *   *作为目标*:
        *   强引用关系 -> **拦截删除** (Block)，返回“存在依赖”错误。
        *   弱推导关系 -> **自动断开** (Detach)。
*   **CI 归档/软删除**: 关系应同步标记为“归档”状态，但在历史快照中仍可追溯。

#### B. 数据质量守护 (Data Quality)
*   **孤岛检测 (Orphan Detection)**: 定期扫描没有任何关联的 CI，生成报表提示运维人员补全。
*   **悬空关系清理 (Dangling Cleanup)**: 自动清理目标 CI 已被物理删除的僵尸关系。
*   **环路检测 (Loop Detection)**: 在物理包含关系 (Composition) 中，严禁出现 A包含B -> B包含A 的死循环。

---

## 3. 高级交互与可视化 (Advanced UX)

### 3.1 拓扑图的“可操作性” (Actionable Topology)
拓扑图不应只是“只读”的壁纸。
*   **编辑模式**:
    *   支持拖拽连线 (Drag & Drop) 创建 `manual` 关系。
    *   支持框选节点进行批量操作 (如：批量变更状态、批量导出)。
*   **上下文钻取**:
    *   点击连线 -> 展示关系的详细属性 (如：连接带宽、协议类型)。
    *   点击节点 -> 侧边栏弹出 CI 核心指标 (CPU/Mem) 概览。

### 3.2 智能分析视图 (Analytical Views)
*   **影响爆炸半径 (Blast Radius)**:
    *   模拟核心节点宕机，高亮所有受影响的业务，并计算“受影响用户数”或“SLA 损失预估”。
*   **孤立点视图**:
    *   一键过滤出没有任何连线的“僵尸服务器”，辅助资源回收。
*   **路径规划**:
    *   展示两个节点之间的所有可能路径 (用于网络排查)。

---

## 4. 非功能性约束 (Non-Functional Requirements)

### 4.1 性能与规模 (Performance & Scale)
*   **节点规模**: 支持 10万+ CI 节点，100万+ 关系边。
*   **查询延迟**:
    *   单节点 1 层展开: < 200ms。
    *   全链路根因回溯 (深度 5): < 1s。
*   **写入吞吐**: 支持每秒 1000+ 关系变更事件。

### 4.2 审计与权限 (Audit & Security)
*   **数据权限**:
    *   用户只能看到自己有权限的 CI 之间的关系。
    *   如果用户有 A 的权限但无 B 的权限，A->B 的关系显示为 A->(Unknown)。
*   **变更审计**:
    *   所有关系的创建/删除 (无论是人工还是自动) 都必须记录审计日志 (Who, When, How)。

---

## 5. 待确认的业务边界 (Open Issues)
1.  **跨环境关联**: 是否允许 `生产环境` 的 App 依赖 `测试环境` 的 DB？ -> 建议默认告警。
2.  **历史回溯**: 是否需要查看“上周五下午 2 点”时的架构拓扑快照？(Time Machine 功能)。
