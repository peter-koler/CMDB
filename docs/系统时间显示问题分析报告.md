# 系统时间显示问题分析报告

## 问题描述

系统中所有日志和记录的时间显示与实际时间相差 8 小时，例如：
- 实际创建时间：2026-02-21 20:35:38 (北京时间)
- 系统显示时间：2026-02-21T12:35:38.272013

## 问题原因

系统在所有模型和业务逻辑中使用 `datetime.utcnow()` 获取 UTC 时间，导致：
- 数据库存储的是 UTC 时间
- API 返回的是 UTC 时间
- 前端直接显示 UTC 时间，与本地时间（北京时间 UTC+8）相差 8 小时

## 解决方案

将所有 `datetime.utcnow()` 替换为 `datetime.now()`，直接使用服务器本地时间。

## 修改文件清单

### 数据模型文件

| 文件 | 修改内容 |
|------|----------|
| `backend/app/models/cmdb_relation.py` | 8 处 `datetime.utcnow` → `datetime.now` |
| `backend/app/models/cmdb_model.py` | 3 处 |
| `backend/app/models/ci_instance.py` | 4 处 |
| `backend/app/models/user.py` | 4 处 |
| `backend/app/models/department.py` | 4 处 |
| `backend/app/models/role.py` | 3 处 |
| `backend/app/models/cmdb_dict.py` | 4 处 |
| `backend/app/models/model_field.py` | 2 处 |
| `backend/app/models/model_region.py` | 2 处 |
| `backend/app/models/model_category.py` | 2 处 |
| `backend/app/models/operation_log.py` | 1 处 |
| `backend/app/models/config.py` | 1 处 |
| `backend/app/models/password_history.py` | 1 处 |

### 业务逻辑文件

| 文件 | 修改内容 |
|------|----------|
| `backend/app/routes/auth.py` | 4 处（账户锁定、密码修改时间） |
| `backend/app/routes/user.py` | 1 处（密码重置时间） |
| `backend/app/routes/cmdb.py` | 1 处（导出时间） |
| `backend/app/routes/log.py` | 1 处（日志清理时间计算） |
| `backend/app/tasks/batch_scan.py` | 4 处（批量扫描任务时间） |

### 测试文件

| 文件 | 修改内容 |
|------|----------|
| `backend/tests/unit/trigger/test_models.py` | 2 处 |
| `backend/tests/unit/notifications/test_models.py` | 1 处 |

## 修改统计

- **总计修改文件数**：21 个
- **总计修改代码行数**：52 处
- **修改类型**：`datetime.utcnow()` → `datetime.now()`

## 修改示例

### 模型字段默认值

```python
# 修改前
created_at = db.Column(db.DateTime, default=datetime.utcnow)
updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# 修改后
created_at = db.Column(db.DateTime, default=datetime.now)
updated_at = db.Column(db.DateTime, default=datetime.now, onupdate=datetime.now)
```

### 业务逻辑时间计算

```python
# 修改前
user.locked_until = datetime.utcnow() + timedelta(hours=lock_duration)

# 修改后
user.locked_until = datetime.now() + timedelta(hours=lock_duration)
```

## 预期效果

修改后，系统所有时间相关功能将使用服务器本地时间：
- 新创建的记录时间正确显示
- 日志时间正确
- 触发器执行日志时间正确
- 批量扫描任务时间正确

## 注意事项

1. **服务器时区**：确保服务器系统时区设置为 `Asia/Shanghai` 或正确的本地时区
2. **历史数据**：已存在的历史数据仍为 UTC 时间，需要手动调整或保持不变
3. **多时区部署**：如果系统需要部署到不同时区的服务器，建议使用方案一（UTC 存储 + 时区转换）

## 验证方法

1. 重启后端服务
2. 创建新的 CI 或触发器
3. 检查创建时间是否与当前本地时间一致
