# CMDB 关系管理功能需求规划

## 1. 项目背景

### 1.1 现状
- 系统已有完整的 CMDB 模型管理和 CI 实例管理功能
- 后端已实现关系管理的数据模型（RelationType、CmdbRelation、RelationTrigger）
- 缺少关系管理的 API 接口和前端功能
- CI 详情页缺少关系信息展示

### 1.2 目标
- 实现完整的 CI 关系管理功能
- 支持手动建立和管理 CI 之间的关系
- 支持通过规则自动建立关系
- 提供拓扑图可视化展示
- 在 CI 详情页展示关联关系

---

## 2. 功能需求

### 2.1 第一阶段功能（MVP）

#### 2.1.1 关系类型管理
**功能描述**：管理系统支持的关系类型定义

**功能点**：
- 关系类型列表展示
- 新增关系类型
- 编辑关系类型
- 删除关系类型
- 关系类型属性：
  - 编码（code）：唯一标识
  - 名称（name）：显示名称
  - 源端描述（source_label）：如"运行"
  - 目标端描述（target_label）：如"承载"
  - 方向（direction）：有向/双向
  - 允许的源模型列表（source_model_ids）：模型对白名单，限制哪些模型可以作为源端
  - 允许的目标模型列表（target_model_ids）：模型对白名单，限制哪些模型可以作为目标端
  - 基数限制（cardinality）：1:1 / 1:N / N:N
  - 是否允许自环（allow_self_loop）：默认否
  - 描述（description）
  - 样式配置（style）：JSON 格式，包含拓扑图连线的样式配置，如：
    - 连线颜色（color）
    - 连线粗细（lineWidth）
    - 连线类型（lineType）：实线/虚线
    - 箭头样式（arrow）

**页面**：系统配置 → 关系类型管理

#### 2.1.2 关系实例管理
**功能描述**：管理 CI 之间的实际关联关系

**功能点**：
- 在 CI 详情页展示关联关系（包含拓扑图和关系列表两个视图）
- 通过箭头方向和样式展示依赖关系和被依赖关系
- 新增关系：选择目标 CI 和关系类型
- 删除关系（不支持编辑已有的关系，只能删除后重建）
- 关系属性：
  - 源 CI
  - 目标 CI
  - 关系类型
  - 关系来源（manual/reference/rule）

**关系约束检查**：
- 唯一性检查：同一对 CI 之间不能创建重复的关系类型
- 自环检查：默认不允许创建 CI 指向自身的关系
- 模型白名单检查：源 CI 和目标 CI 的模型必须在关系类型允许的模型列表中
- 基数限制检查：根据关系类型的基数限制（1:1 / 1:N / N:N）验证关系创建

**引用属性同步**：
- 当 CI 的引用类型字段值变化时，自动创建/更新/删除对应的关系
- 引用属性关系的来源标记为 `reference`
- 引用字段值设置时：自动创建关系
- 引用字段值变更时：自动更新关系（删除旧关系，创建新关系）
- 引用字段值清空时：自动删除对应的关系
- 示例：应用的 `host_id` 字段指向主机时，自动创建"运行在"关系

**双向关系处理**：
- 数据库中只存储一条关系记录
- 关系类型为双向时，拓扑图中展示为双向箭头
- 查询时，双向关系在两个方向都可以被检索到

**CI 删除时的关系处理**：
- 删除 CI 前检查是否存在关联关系
- 如果有关联关系，提示用户确认是否同时删除关联关系
- 用户确认后，级联删除该 CI 的所有关联关系（作为源和作为目标的）

**页面**：CI 详情页 → 关系拓扑 Tab

#### 2.1.3 关系触发器管理
**功能描述**：配置自动建立关系的规则

**功能点**：
- 触发器列表展示
- 新增触发器
- 编辑触发器
- 删除触发器
- 启用/禁用触发器
- 触发器属性：
  - 名称
  - 源模型
  - 目标模型
  - 关系类型
  - 触发类型（reference/expression）
  - 触发条件（JSON 配置）
  - 描述

**页面**：系统配置 → 关系触发器管理

#### 2.1.4 拓扑图可视化
**功能描述**：以拓扑图形式展示 CI 之间的关系

**功能点**：

**场景一：CI 详情页关系展示**
- 单个 Tab，包含两个视图切换：拓扑图视图、关系列表视图
- 拓扑图视图：
  - 以当前 CI 为中心，展示其关联的 CI
  - 支持选择展开层数：1层、2层、3层、4层
  - 通过箭头方向展示关系方向：
    - 箭头指向外：当前 CI 依赖其他 CI（出边）
    - 箭头指向内：其他 CI 依赖当前 CI（入边）
    - 双向箭头：双向关系
  - 节点展示 CI 基本信息（名称、编码、模型图标）
  - 连线标注关系类型名称
  - 点击节点：侧边栏展示该 CI 的简要信息，侧边栏提供跳转详情页的按钮
  - 支持缩放和平移
  - 支持拖拽节点调整位置
- 关系列表视图：
  - 表格形式展示所有关联关系
  - 分为"依赖的"和"被依赖的"两个子 Tab
  - 列表字段：关系类型、对方 CI 名称、对方 CI 编码、对方 CI 模型、关系来源、创建时间
  - 支持删除关系操作

**场景二：独立全局拓扑视图**
- 独立页面：CMDB → 拓扑视图
- 搜索过滤功能：
  - 搜索框：按 CI 名称/编码搜索
  - 模型筛选：下拉选择模型，只展示该模型的 CI
- 支持选择起点：
  - 选择模型：展示该模型下所有 CI 及其关系
  - 选择 CI：从该 CI 开始展开
  - 空选择：展示所有有连线的 CI（按数量限制）
- 支持节点展开/收起：点击节点可展开/收起其关联节点
- 支持拖拽交互：拖拽节点调整位置
- 节点展示 CI 基本信息（名称、编码、模型图标）
- 连线展示关系类型
- 点击节点：侧边栏展示该 CI 的简要信息，侧边栏提供跳转详情页的按钮
- 支持缩放和平移
- 支持画布适配：一键将整个拓扑图适配到画布大小
- 布局算法选择：
  - 力导向布局（默认）：节点自动散开
  - 层级布局：从上到下的层级布局，适合依赖关系
  - 环形布局：节点围成一圈
  - 网格布局：节点整齐排列

**拓扑图编辑模式**：
- 支持查看模式和编辑模式切换
- 编辑模式下支持拖拽连线创建关系：
  - 从源节点拖拽到目标节点
  - 松开后弹出选择关系类型的对话框
  - 确认后创建关系
- 编辑模式下支持删除关系：
  - 点击连线
  - 弹出确认删除对话框
  - 确认后删除关系

**拓扑图样式**：
- 节点样式：按模型区分颜色/图标
- 连线样式：按关系类型区分颜色/线型
- 高亮效果：鼠标悬停时高亮节点及关联连线
- 编辑模式下显示连线和删除按钮

**数据导出**：
- 支持导出拓扑图数据为 Excel/CSV 格式
- 导出内容：CI 信息、关系信息

**页面**：
- CI 详情页 → 关系拓扑 Tab
- CMDB → 拓扑视图（独立页面）

### 2.2 第二阶段功能（高级特性）

#### 2.2.1 关系批量操作
- 批量建立关系
- 批量删除关系
- 批量导出关系

#### 2.2.2 关系审计
- 关系变更历史记录
- 关系变更对比

#### 2.2.3 关系分析
- 影响分析：选择一个 CI，分析其影响范围
- 孤岛检测：找出没有任何关系的 CI
- 环路检测：检测关系环路

---

## 3. 技术方案

### 3.1 后端 API 设计

#### 3.1.1 关系类型接口
```
GET    /api/v1/cmdb/relation-types          # 获取关系类型列表
POST   /api/v1/cmdb/relation-types          # 新增关系类型
GET    /api/v1/cmdb/relation-types/:id      # 获取关系类型详情
PUT    /api/v1/cmdb/relation-types/:id      # 更新关系类型
DELETE /api/v1/cmdb/relation-types/:id      # 删除关系类型
```

#### 3.1.2 关系实例接口
```
GET    /api/v1/cmdb/instances/:id/relations   # 获取 CI 的关联关系
POST   /api/v1/cmdb/relations                  # 新增关系
DELETE /api/v1/cmdb/relations/:id              # 删除关系
GET    /api/v1/cmdb/topology                   # 获取拓扑图数据
```

#### 3.1.3 关系触发器接口
```
GET    /api/v1/cmdb/relation-triggers          # 获取触发器列表
POST   /api/v1/cmdb/relation-triggers          # 新增触发器
GET    /api/v1/cmdb/relation-triggers/:id      # 获取触发器详情
PUT    /api/v1/cmdb/relation-triggers/:id      # 更新触发器
DELETE /api/v1/cmdb/relation-triggers/:id      # 删除触发器
PUT    /api/v1/cmdb/relation-triggers/:id/toggle # 启用/禁用触发器
```

### 3.2 前端技术选型

- 拓扑图库：AntV G6 或 ECharts Graph
- 状态管理：Pinia（已有）
- UI 组件：Ant Design Vue（已有）

### 3.3 数据模型

已有的数据模型（backend/app/models/cmdb_relation.py）：
- RelationType：关系类型
- CmdbRelation：关系实例
- RelationTrigger：关系触发器

---

## 4. 实施计划

### 4.1 第一阶段实施步骤

#### 步骤 1：后端 API 开发
1. 实现关系类型 CRUD 接口（包含模型白名单、基数限制等属性）
2. 实现关系实例 CRUD 接口（包含关系约束检查）
3. 实现拓扑图数据接口（支持多层展开、按模型过滤、搜索）
4. 实现关系触发器 CRUD 接口
5. 实现引用属性同步逻辑（包含引用字段清空时的处理）
6. 实现 CI 删除时的关系处理逻辑
7. 实现双向关系查询逻辑
8. 实现数据导出接口（Excel/CSV）

#### 步骤 2：前端基础功能开发
1. 关系类型管理页面（包含模型白名单、基数限制配置）
2. CI 详情页增加关系拓扑 Tab（包含拓扑图和关系列表两个视图）
3. 关系新增/删除功能（不支持编辑）
4. CI 删除时的关系确认提示
5. 关系列表视图（分为"依赖的"和"被依赖的"）

#### 步骤 3：拓扑图开发
1. 集成拓扑图组件（推荐使用 AntV G6）
2. 实现基础拓扑展示（CI 详情页和独立页面）
3. 实现节点展开层数选择（1-4层）
4. 实现节点点击侧边栏展示 + 跳转按钮
5. 实现搜索过滤功能（按 CI 名称/编码搜索、按模型过滤）
6. 实现多种布局算法（力导向、层级、环形、网格）
7. 实现编辑模式：拖拽连线创建关系
8. 实现编辑模式：点击连线删除关系
9. 实现缩放、平移、画布适配
10. 实现数据导出功能（Excel/CSV）

#### 步骤 4：关系触发器开发
1. 关系触发器管理页面
2. 触发器配置表单（重点实现引用类型触发器）
3. 触发器启用/禁用

### 4.2 时间估算

| 阶段 | 任务 | 预计工时 |
|------|------|----------|
| 第一阶段 | 后端 API 开发 | 5 天 |
| 第一阶段 | 前端基础功能 | 3 天 |
| 第一阶段 | 拓扑图开发 | 7 天 |
| 第一阶段 | 关系触发器 | 2 天 |
| 第一阶段 | 测试与联调 | 3 天 |
| **第一阶段总计** | | **20 天** |

---

## 5. 非功能需求

### 5.1 性能
- 拓扑图支持 1000+ 节点流畅展示
- 关系查询响应时间 < 500ms

### 5.2 安全
- 所有 API 需要认证
- 遵循现有数据权限规则

### 5.3 兼容性
- 支持主流浏览器（Chrome、Firefox、Safari、Edge）

---

## 6. 风险与应对

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 拓扑图性能问题 | 高 | 中 | 选用成熟的拓扑图库，做好性能测试 |
| 触发器逻辑复杂 | 中 | 中 | 先实现引用属性同步，规则推导后续优化 |
| 数据一致性问题 | 高 | 低 | 做好数据库事务，添加唯一约束 |

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 关系类型可以正常增删改查（包含模型白名单、基数限制配置）
- [ ] 关系约束检查生效（唯一性、自环、模型白名单、基数限制）
- [ ] 可以在 CI 详情页查看和管理关系（包含拓扑图和关系列表两个视图）
- [ ] 关系不支持编辑，只能删除后重建
- [ ] 双向关系处理正常（数据库只存一条，展示双向箭头）
- [ ] 引用属性同步功能正常工作（包含引用字段清空时自动删除关系）
- [ ] CI 删除时正确提示并处理关联关系
- [ ] 拓扑图可以正常展示 CI 关系（CI 详情页和独立页面）
- [ ] CI 详情页拓扑图支持选择展开层数（1-4层）
- [ ] CI 详情页关系列表视图正常（已由第10章替代为单列表+方向列）
- [ ] 全局拓扑视图搜索过滤功能正常（按 CI 名称/编码搜索、按模型过滤）
- [ ] 全局拓扑视图支持多种布局算法（力导向、层级、环形、网格）
- [ ] 拓扑图节点点击侧边栏展示 + 跳转按钮功能正常
- [ ] 拓扑图编辑模式可以正常使用（拖拽连线创建关系、点击删除关系）
- [ ] 数据导出功能正常（Excel/CSV）
- [ ] 关系触发器可以正常配置和启用（重点验证引用类型触发器）

### 7.2 性能验收
- [ ] 拓扑图加载 100 个节点 < 2s
- [ ] 关系查询 API 响应 < 500ms

---

## 8. 后续优化方向

1. 关系批量操作
2. 关系审计日志
3. 关系影响分析
4. 历史快照
5. 更丰富的拓扑图交互

---

## 9. 2026-02-15 优化变更（模型图标与关键属性展示）

> 说明：本章为当日早期版本记录。若与第 10 章存在冲突，以第 10 章“当日增量更新（已实现同步）”为准。

### 9.1 变更背景
- 在拓扑图中，节点缺少模型图标和模型关键属性值展示，业务识别成本高。
- 模型管理仅支持内置图标名称，缺少自定义图标上传能力。

### 9.2 变更目标
- 模型管理支持“内置图标 + 自定义上传图标”双能力。
- 模型支持配置关键属性（最多 3 个），用于拓扑节点信息展示。
- 拓扑节点展示规则统一：
  - 主标题：CI 名称（为空时回退 CI 编码）
  - 副标题：关键属性值（按配置顺序，仅展示值）
  - 回退规则：未配置关键属性或关键属性值为空时，展示 CI 编码
  - 注：该回退规则在后续实现中已调整，详见第 10 章。

### 9.3 需求细化

#### 9.3.1 模型管理增强
- 新增模型图标配置能力：
  - 内置图标选择（保持原有 `icon` 字段）
  - 上传自定义图标（png/svg，最大 2MB）
  - 生效优先级：上传图标 > 内置图标
- 新增关键属性配置能力：
  - 从模型字段中选择，最多 3 个
  - 支持字段类型：文本/数字/枚举/日期（不包含 file/image）
  - 按选择顺序展示

#### 9.3.2 拓扑展示增强
- 全局拓扑与 CI 详情拓扑统一展示以下节点信息：
  - `display_title`（主标题）
  - `display_subtitles`（关键属性值数组）
  - `model_icon` / `model_icon_url`（模型图标信息）
- 节点侧边栏信息同步展示关键属性值。

### 9.4 接口与数据调整
- 模型接口新增字段（创建/更新/详情/列表）：
  - `icon_url`
  - `key_field_codes`
- 新增模型图标上传接口：
  - `POST /api/v1/cmdb/models/icon-upload`
  - `GET /api/v1/cmdb/models/icon-files/:path`
- 拓扑相关接口节点数据新增字段：
  - `display_title`
  - `display_subtitles`
  - `model_icon`
  - `model_icon_url`

### 9.5 验收补充
- [ ] 模型管理页可选择内置图标并上传自定义图标（png/svg，<=2MB）。
- [ ] 上传图标在模型列表、拓扑节点中按优先级正确生效。
- [ ] 模型关键属性最多可配置 3 个，超限时前后端均拦截。
- [ ] 拓扑节点主标题为 CI 名称，副标题展示关键属性值。
- [ ] 未配置关键属性或关键属性值均为空时，节点显示 CI 编码。

---

## 10. 2026-02-15 当日增量更新（已实现同步）

### 10.1 拓扑视图（独立页面）规则调整
- 节点展示调整为“模型图标 + 关键属性值”，不再展示 CI 编码作为节点文案。
- 节点列表仅展示关键属性值；若未配置关键属性，展示“未配置关键属性”。
- 起点 CI 下拉展示文案改为关键属性值（不显示 CI 编码），并支持随模型筛选联动。
- 节点支持拖拽交互（拖拽节点调整位置）。
- 点击拓扑节点可直接打开 CI 详情抽屉（与 CI 详情页体验一致）。

### 10.2 拓扑图图标能力增强
- 节点从“模型颜色圆点”升级为“模型图标节点”：
  - 优先使用模型上传图标 `icon_url`
  - 无上传图标时，使用内置 Ant Design 图标矢量渲染（SVG）
- 图标加载失败时自动回退至内置图标，避免前端 `img error` 影响可用性。
- 连线样式统一优化：支持方向箭头、关系名称标注、引用关系虚线。

### 10.3 CI 详情页优化（关系管理）
- “关系列表”由双表（依赖/被依赖）改为单一统一列表，新增方向列（依赖/被依赖）。
- “拓扑图”展示方式对齐独立拓扑页：
  - 模型图标节点展示
  - 统一连线样式与标签
  - 支持拖拽、缩放、适配
- 在 CI 详情 -> 关系拓扑中点击节点，可直接切换并查看被点击 CI 的详情（抽屉内切换）。

### 10.4 CI 详情页优化（属性信息）
- 修复属性数据为空问题：属性值读取兼容 `attributes` 与 `attribute_values`。
- 属性展示按模型动态表单（`form_config`）解析，支持分组（group.children）。
- 展示样式调整为业务可读版：`字段名：值`，值使用浅蓝色信息框。
- 支持按模型配置 span（24/12/8/6）进行 1/1、1/2、1/3、1/4 布局展示。
- 支持常见动态字段展示：文本、数值、枚举、布尔、日期/时间、图片、附件、numberRange。

### 10.5 模型管理图标交互优化
- 模型图标选择从下拉改为“缩略图可视化单选”。
- 自定义上传图标纳入同一图标卡片区域，与内置图标统一单选规则。
- 提交时根据选中来源写入（内置图标或上传图标）。

### 10.6 CI 复制功能修复
- 修复“复制 CI”误走编辑接口导致 `/api/v1/cmdb/instances/null` 404 的问题。
- 判定规则更新：
  - `instance.id` 有值：编辑
  - `instance.id` 为空：复制（按新增流程创建）

### 10.7 构建与工程兼容调整
- 增加 `frontend/scripts/vue-tsc-compat.cjs`，兼容 Node 22 + 旧版 `vue-tsc` 补丁机制差异。
- `frontend/package.json` 调整：
  - `build` 使用 `vite build`
  - 新增 `typecheck` 命令独立执行类型检查

### 10.8 当日验收补充
- [ ] 独立拓扑页节点文案仅显示关键属性值，不显示 CI 编码。
- [ ] 独立拓扑页起点 CI 下拉按关键属性值展示。
- [ ] 独立拓扑页与 CI 详情拓扑均使用模型图标节点（上传图标优先）。
- [ ] CI 详情页关系列表为单列表展示（含方向区分）。
- [ ] CI 详情页关系拓扑点击节点可切换并展示目标 CI 详情。
- [ ] CI 详情页属性信息按动态表单正确渲染并展示值。
- [ ] CI 复制功能不再触发 `/instances/null` 请求。

### 10.9 评审口径（冲突消解）
- CI 详情页“关系列表”评审口径：以单一列表为准，不再要求“依赖的/被依赖的”双列表。
- 拓扑节点文案评审口径：以关键属性值为准，不再以 CI 编码作为默认显示内容。
- 起点 CI 筛选评审口径：以下拉展示关键属性值为准，不再以 CI 编码展示。
- 拓扑节点点击行为评审口径：点击节点后可直接查看该 CI 详情（全局拓扑与 CI 详情拓扑行为一致）。
- 若第 7 章验收项与本章冲突，以本章（第 10 章）为最终验收标准。
