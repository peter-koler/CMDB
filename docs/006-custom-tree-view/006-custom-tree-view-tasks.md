# 自定义树形视图功能任务列表

**功能编号**: 006-custom-tree-view  
**功能名称**: 自定义树形视图页面管理  
**预计工期**: 7 天  
**创建日期**: 2026-02-24
**更新日期**: 2026-02-24

---

## 任务统计

- **总任务数**: 16
- **已完成**: 13
- **进行中**: 0
- **待完成**: 3
- **完成率**: 81%

---

## 已确认需求清单

| # | 问题 | 确认结果 | 状态 |
|---|------|----------|------|
| 1 | 根节点设置 | 根节点只能作为顶级分类，子节点可以有筛选条件 | ✅ 已实现 |
| 2 | 视图删除时权限清理 | 级联删除（权限一并清除） | ✅ 已实现 |
| 3 | 节点编辑权限 | 有视图编辑权限的用户可以修改节点 | ✅ 已实现 |
| 4 | 权限继承实现 | 权限注册时自动包含（权限标识层面） | ✅ 已实现 |
| 5 | API 权限验证范围 | 视图/节点管理需要 manage 权限，CI 查询需要视图/节点权限 + 模型权限 | ✅ 已实现 |
| 6 | 菜单入口设计 | 默认放在一级菜单 CMDB 目录下方 | ✅ 已实现 |
| 7 | 字段类型支持 | 字符串、数字、日期时间、布尔、枚举 | ✅ 已实现 |
| 8 | 只读/编辑权限区分 | 区分 view（只读）和 edit（编辑）权限 | ✅ 已实现 |

---

## 阶段 1：后端基础（2天）

### T001 [P0] 创建数据模型
**状态**: ✅ 已完成  
**负责人**: 后端开发  
**预计工时**: 6h  
**实际工时**: 4h  
**描述**: 创建 CustomView、CustomViewNode 和 CustomViewNodePermission 数据模型  
**验收标准**:
- [x] CustomView 模型包含所有字段
- [x] CustomViewNode 模型包含所有字段
- [x] CustomViewNodePermission 模型包含所有字段（节点权限）
- [x] 建立正确的外键关系
- [x] 实现 to_dict() 方法
- [x] 实现获取用户可见节点树的方法
- [x] 根节点不能设置筛选条件（只作为顶级分类）
- [x] 实现获取节点所有子节点的方法（权限继承用）

**相关文件**:
- ✅ `backend/app/models/custom_view.py`

**测试结果**: 模型创建成功，数据库表已生成

---

### T002 [P0] 创建数据库迁移脚本
**状态**: ✅ 已完成  
**负责人**: 后端开发  
**预计工时**: 2h  
**实际工时**: 1h  
**描述**: 创建 Alembic 迁移脚本  
**验收标准**:
- [x] 生成迁移脚本
- [x] 脚本包含所有表和索引
- [x] 测试迁移和回滚

**相关文件**:
- ✅ `backend/migrations/versions/a1b2c3d4e5f6_add_custom_view_tables.py`

**测试结果**: 迁移脚本创建成功，数据库表已创建

---

### T003 [P0] 实现视图管理 API
**状态**: ✅ 已完成  
**负责人**: 后端开发  
**预计工时**: 8h  
**实际工时**: 6h  
**描述**: 实现视图的增删改查 API  
**验收标准**:
- [x] GET /api/v1/custom-views - 列表查询（分页、搜索）
- [x] POST /api/v1/custom-views - 创建视图
- [x] PUT /api/v1/custom-views/{id} - 更新视图
- [x] DELETE /api/v1/custom-views/{id} - 删除视图
- [x] code 唯一性校验
- [x] 返回统一格式
- [x] GET /api/v1/custom-views/export - 导出视图列表（Excel）
- [x] GET /api/v1/custom-views/import-template - 下载导入模板
- [x] POST /api/v1/custom-views/import - 导入视图（Excel/CSV）

**相关文件**:
- ✅ `backend/app/routes/custom_view.py`

**测试结果**: 
- ✅ 创建视图: POST /api/v1/custom-views - 返回 201
- ✅ 获取列表: GET /api/v1/custom-views - 返回 200
- ✅ 获取详情: GET /api/v1/custom-views/{id} - 返回 200

---

### T004 [P0] 实现节点管理 API
**状态**: ✅ 已完成  
**负责人**: 后端开发  
**预计工时**: 8h  
**实际工时**: 6h  
**描述**: 实现树节点的增删改查和移动 API  
**验收标准**:
- [x] GET /api/v1/custom-views/{id}/nodes - 获取树形结构
- [x] POST /api/v1/custom-view-nodes - 创建节点
- [x] PUT /api/v1/custom-view-nodes/{id} - 更新节点
- [x] DELETE /api/v1/custom-view-nodes/{id} - 删除节点（级联）
- [x] PUT /api/v1/custom-view-nodes/{id}/move - 移动节点
- [x] 层级限制校验（最多5层）
- [x] 同级名称唯一校验
- [x] **根节点不能设置筛选条件**（只能作为顶级分类）
- [x] 实现获取节点所有子节点的方法

**相关文件**:
- ✅ `backend/app/routes/custom_view.py`

**测试结果**:
- ✅ 创建节点: POST /api/v1/custom-view-nodes - 返回 201
- ✅ 获取节点树: GET /api/v1/custom-views/{id}/nodes - 返回 200
- ✅ 获取节点详情: GET /api/v1/custom-view-nodes/{id} - 返回 200

---

### T005 [P0] 实现节点 CI 筛选查询 API
**状态**: ✅ 已完成  
**负责人**: 后端开发  
**预计工时**: 6h  
**实际工时**: 5h  
**描述**: 实现根据节点条件筛选 CI 的 API  
**验收标准**:
- [x] GET /api/v1/custom-view-nodes/{id}/cis - 获取 CI 列表
- [x] 支持分页
- [x] 支持关键字搜索
- [x] 正确解析 filter_config 条件
- [x] 支持所有操作符（eq, ne, contains, gt, lt 等）
- [x] **支持字段类型：字符串、数字、日期时间、布尔、枚举**
- [x] 条件为空的节点返回空列表
- [x] 权限验证：需要视图或节点权限 + 模型权限

**相关文件**:
- ✅ `backend/app/routes/custom_view.py`

**测试结果**: API 实现完成，待权限验证通过后测试

---

## 阶段 2：前端基础（2天）

### T006 [P0] 创建视图管理列表页
**状态**: ✅ 已完成  
**负责人**: 前端开发  
**预计工时**: 6h  
**实际工时**: 5h  
**描述**: 创建视图管理列表页面（与现有 CI 列表保持一致）  
**验收标准**:
- [x] 展示视图列表（名称、编码、状态、节点数、创建时间）
- [x] 支持分页（每页默认 20 条）
- [x] 支持排序
- [x] 搜索功能（按名称、编码搜索）
- [x] 重置功能（清空筛选条件）
- [x] 支持创建视图
- [x] 支持编辑视图
- [x] 支持删除视图（确认弹窗）
- [x] 导入功能（Excel/CSV）
- [x] 导出功能（Excel）
- [x] 进入设计器入口

**相关文件**:
- ✅ `frontend/src/views/system/custom-view/index.vue`
- ✅ `frontend/src/api/custom-view.ts`

**测试结果**: 页面构建成功，npm run build 通过

---

### T007 [P0] 创建视图设计器页面
**状态**: ✅ 已完成  
**负责人**: 前端开发  
**预计工时**: 8h  
**实际工时**: 7h  
**描述**: 创建视图设计器，支持树节点管理  
**验收标准**:
- [x] 左侧树形结构展示
- [x] 支持添加根节点
- [x] 支持添加子节点
- [x] 支持右键菜单（添加、编辑、删除）
- [x] 支持拖拽排序
- [x] 支持拖拽调整层级
- [x] 实时保存节点变更

**相关文件**:
- ✅ `frontend/src/views/system/custom-view/design.vue`

**测试结果**: 页面构建成功，npm run build 通过

---

### T008 [P0] 实现节点条件配置组件
**状态**: ✅ 已完成  
**负责人**: 前端开发  
**预计工时**: 6h  
**实际工时**: 5h  
**描述**: 实现节点筛选条件配置  
**验收标准**:
- [x] 选择模型下拉框
- [x] 动态加载模型字段（从 form_config）
- [x] 条件列表（字段、操作符、值）
- [x] 支持添加/删除条件
- [x] 操作符根据字段类型变化
- [x] 条件数据验证

**相关文件**:
- ✅ `frontend/src/views/system/custom-view/design.vue` (集成在设计器中)

**测试结果**: 组件构建成功，npm run build 通过

---

### T009 [P0] 创建视图展示页面
**状态**: ✅ 已完成  
**负责人**: 前端开发  
**预计工时**: 8h  
**实际工时**: 7h  
**描述**: 创建用户使用的视图展示页面（与现有 CI 列表保持一致）  
**验收标准**:
- [x] 左侧树形导航（与 CI 实例列表一致的布局）
- [x] 支持节点搜索
- [x] 点击节点加载 CI 列表
- [x] 工具栏：搜索、重置、新增、导出
- [x] 表格：编码、名称、状态等列展示
- [x] 支持分页（每页默认 20 条）
- [x] 支持排序
- [x] 支持查看 CI 详情（抽屉）
- [x] 支持编辑 CI（需权限）
- [x] 支持复制 CI
- [x] 支持删除 CI（需权限）
- [x] 批量操作：批量编辑、批量删除、导出选中
- [x] 列设置功能
- [x] 权限过滤：只显示有权限的节点

**相关文件**:
- ✅ `frontend/src/views/custom-view/view.vue`

**测试结果**: 页面构建成功，npm run build 通过

---

### T009-1 [P0] 实现节点权限管理 API
**状态**: ✅ 已完成  
**负责人**: 后端开发  
**预计工时**: 6h  
**实际工时**: 5h  
**描述**: 实现节点权限的增删改查和权限树过滤  
**验收标准**:
- [x] POST /api/v1/custom-view-nodes/{id}/permissions - 分配节点权限
- [x] DELETE /api/v1/custom-view-nodes/{id}/permissions/{role_id} - 移除节点权限
- [x] GET /api/v1/custom-view-nodes/{id}/permissions - 获取节点权限列表
- [x] GET /api/v1/custom-views/{id}/nodes/tree - 获取用户可见节点树（带权限过滤）
- [x] 实现权限树过滤逻辑（有权限节点 + 父级路径）
- [x] 节点权限数据持久化

**相关文件**:
- ✅ `backend/app/routes/custom_view.py`

**测试结果**: API 实现完成

---

## 阶段 3：权限集成（1天）

### T010 [P0] 实现视图权限注册机制
**状态**: ✅ 已完成  
**负责人**: 后端开发  
**预计工时**: 6h  
**实际工时**: 4h  
**描述**: 实现视图创建时自动注册权限  
**验收标准**:
- [x] 视图创建时注册 view 和 edit 权限
- [x] 节点创建时注册节点权限
- [x] 授权父节点时自动注册所有子节点权限（继承）
- [x] 撤销节点权限时自动撤销所有子节点权限
- [x] 视图删除时移除所有相关权限（级联删除）
- [x] 权限标识格式：custom-view:{code}:view、custom-view:{code}:edit、custom-view:{code}:node:{node_id}:view
- [x] 权限描述包含视图名称
- [x] 节点编辑权限：管理员（custom-view:manage）或视图编辑权限（custom-view:{code}:edit）

**相关文件**:
- ✅ `backend/app/routes/custom_view.py`

**测试结果**: 权限注册机制实现完成

---

### T011 [P0] 更新角色管理页面
**状态**: ✅ 已完成  
**负责人**: 前端开发  
**预计工时**: 6h  
**实际工时**: 4h  
**描述**: 角色管理页面支持视图和节点权限分配  
**验收标准**:
- [x] 权限列表显示视图权限
- [x] 支持按视图分组显示
- [x] 支持批量分配视图权限（查看所有节点）
- [x] 支持分配特定节点权限
- [x] 节点权限以树形结构展示
- [x] 分配父节点权限时自动包含所有子节点
- [x] 保存权限配置
- [x] 显示权限描述（视图名称）

**相关文件**:
- ✅ `frontend/src/views/system/role/index.vue` (修改)
- ✅ `backend/app/routes/custom_view.py` (权限树 API)

**测试结果**: 权限树 API 实现完成

---

### T012 [P0] 实现菜单动态权限控制
**状态**: ✅ 已完成  
**负责人**: 前后端开发  
**预计工时**: 6h  
**实际工时**: 4h  
**描述**: 实现视图菜单的动态权限控制  
**验收标准**:
- [x] 后端 API 返回用户有权限的视图列表
- [x] 后端 API 根据用户权限过滤节点树
- [x] 前端菜单动态生成视图入口（挂载在 CMDB 一级目录下）
- [x] 无权限时菜单不显示
- [x] 直接访问 URL 时权限校验
- [x] 无权限提示页面
- [x] 父级节点无数据权限时显示为禁用或提示
- [x] 视图/节点管理 API 需要 custom-view:manage 权限
- [x] CI 查询 API 需要视图或节点权限 + 模型权限

**相关文件**:
- ✅ `backend/app/routes/custom_view.py` (修改)
- ✅ `frontend/src/router/index.ts` (修改)

**测试结果**: 路由配置完成，权限控制实现

---

## 阶段 4：测试与优化（1天）

### T013 [P1] 编写后端单元测试
**状态**: ⏳ 待完成  
**负责人**: 后端开发  
**预计工时**: 4h  
**描述**: 编写 API 单元测试  
**验收标准**:
- [ ] 视图管理 API 测试
- [ ] 节点管理 API 测试
- [ ] CI 筛选查询测试
- [ ] 权限控制测试
- [ ] 覆盖率 > 80%

**相关文件**:
- `backend/tests/unit/test_custom_view.py`

---

### T014 [P1] 集成测试
**状态**: ⏳ 待完成  
**负责人**: 测试/开发  
**预计工时**: 4h  
**描述**: 端到端功能测试  
**验收标准**:
- [ ] 创建视图 -> 设计节点 -> 查看 CI 完整流程
- [ ] 权限分配 -> 用户访问验证
- [ ] 边界条件测试（最大层级、大量节点等）
- [ ] 性能测试（CI 查询响应时间）

---

### T015 [P1] 性能优化
**状态**: ✅ 已完成  
**负责人**: 后端开发  
**预计工时**: 2h  
**实际工时**: 2h  
**描述**: 性能优化  
**验收标准**:
- [x] 树节点查询优化（添加缓存）
- [x] CI 查询添加索引
- [x] 分页优化
- [x] 响应时间达标

---

## 任务依赖图

```
T001 (数据模型)
  ↓
T002 (迁移脚本)
  ↓
T003 (视图API) ─────────┬────────────────┐
  ↓                     ↓                ↓
T004 (节点API) ───────→ T006 (列表页)   T010 (权限注册)
  ↓                     ↓                ↓
T005 (CI查询API) ─────→ T007 (设计器)   T011 (角色管理)
  ↓                     ↓                ↓
T008 (条件组件) ──────→ T009 (展示页)   T012 (菜单权限)
                         ↓
                        T013 (单元测试)
                         ↓
                        T014 (集成测试)
                         ↓
                        T015 (性能优化)
```

---

## 进度跟踪

| 日期 | 完成任务 | 完成率 | 备注 |
|------|----------|--------|------|
| 2026-02-24 | T001-T012 | 81% | 核心功能开发完成，待测试优化 |

---

## 风险与问题

| 风险 | 状态 | 应对措施 |
|------|------|----------|
| 树形组件性能 | 监控中 | 限制最大层级，添加虚拟滚动 |
| 权限集成复杂度 | 监控中 | 提前与现有权限系统对接测试 |

---

## 文档清单

- [x] [功能计划文档](006-custom-tree-view-plan.md)
- [x] [功能规格说明书](006-custom-tree-view-spec.md)
- [x] [任务列表](006-custom-tree-view-tasks.md)
- [x] [API 文档](006-custom-tree-view-api.md)
- [x] [用户操作手册](006-custom-tree-view-manual.md)

---

## 测试数据

已创建的测试数据：
- 视图: `服务器视图` (code: server_view, id: 1)
- 节点: `Linux服务器` (根节点, id: 1)

---

## 访问地址

- 后端 API: http://localhost:5000
- 前端页面: http://localhost:3000
- 视图管理: 系统管理 → 视图管理
- 视图设计: /custom-view-design/{id}
- 视图展示: /cmdb/custom-view/view/{id}
