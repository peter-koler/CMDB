# IT运维平台需求说明书 V1.0

**文档版本**: 1.0  
**编写日期**: 2024年  
**适用范围**: IT运维平台开发

---

## 目录

1. [系统概述](#1-系统概述)
2. [基础功能](#2-基础功能)
3. [组织架构管理](#3-组织架构管理)
4. [权限管理体系](#4-权限管理体系)
5. [配置仓库(CMDB)](#5-配置仓库cmdb)
6. [业务规则说明](#6-业务规则说明)
7. [数据权限控制](#7-数据权限控制)
8. [附录](#8-附录)

---

## 1. 系统概述

### 1.1 项目背景

IT运维平台是一个面向企业IT基础设施管理的综合平台，旨在通过模型化管理、权限控制、审计追踪等功能，实现IT资产的规范化管理。

### 1.2 技术架构

- **前端**: Vue 3 + TypeScript + Ant Design Vue 4.x + Pinia
- **后端**: Flask + SQLAlchemy + JWT
- **数据库**: SQLite(开发) / PostgreSQL或MySQL(生产)

### 1.3 核心模块

1. **系统管理**: 用户管理、部门管理、角色管理、系统配置、日志审计
2. **模型管理**: 模型分类、模型定义、字段设计、表单设计器
3. **配置仓库**: CI实例管理、动态表单、全文搜索、变更历史

---

## 2. 基础功能

### 2.1 用户认证

#### 2.1.1 登录认证
- **认证方式**: JWT Token (Access Token + Refresh Token)
- **安全策略**:
  - 密码 bcrypt 加密存储
  - 连续登录失败5次后账户锁定24小时
  - Token自动续期机制
  - 密码复杂度校验（长度、大小写、数字、特殊字符）
  - 密码历史检查（不能与最近5次密码重复）

#### 2.1.2 Token策略
- **Access Token**: 30分钟有效期（可配置）
- **Refresh Token**: 7天有效期（可配置）
- 支持手动刷新和自动续期

### 2.2 系统配置

#### 2.2.1 配置项分类
1. **Token配置**: Access/Refresh Token有效期
2. **密码策略**: 最小长度、强制修改周期、历史检查次数、复杂度要求
3. **登录安全**: 最大失败次数、锁定时间
4. **日志配置**: 日志保留天数

#### 2.2.2 配置管理
- 配置存储在数据库，支持热更新
- 配置变更记录操作日志
- 仅管理员可修改配置

### 2.3 操作日志审计

#### 2.3.1 日志记录内容
- 操作人、操作时间、操作类型、操作对象
- 操作描述、IP地址、用户代理
- 操作结果（成功/失败）、错误信息

#### 2.3.2 日志类型
- 登录/登出
- 创建/更新/删除/查询
- 导入/导出

#### 2.3.3 日志管理
- 支持按时间范围、用户、操作类型、状态筛选
- 支持导出CSV
- 自动清理超期日志

---

## 3. 组织架构管理

### 3.1 部门管理

#### 3.1.1 部门属性
- **基础信息**: 部门名称、部门编码、排序号
- **层级关系**: 支持无限层级，通过parent_id关联
- **负责人**: 可选关联部门负责人
- **路径存储**: 存储完整路径（如 /1/2/5/），便于查询子部门

#### 3.1.2 部门树展示
- 左侧树形结构展示部门层级
- 支持展开/折叠
- 支持拖拽排序
- 右键菜单：添加子部门、编辑、删除

#### 3.1.3 部门操作
**创建部门**:
- 必填：名称、编码
- 可选：上级部门、排序号
- 校验：编码唯一性

**编辑部门**:
- 可修改：名称、排序号、负责人
- 不可修改：编码（已使用后）

**删除部门**:
- 前置校验：无子部门、无关联用户
- 删除失败给出明确提示

#### 3.1.4 部门与用户关联
**多对多关系**:
- 一个用户可属于多个部门
- 一个部门可包含多个用户
- 支持标记部门负责人（is_leader）

**批量关联**:
- 部门详情页支持批量添加/移除用户
- 用户管理页支持设置用户所属部门

### 3.2 用户管理（增强版）

#### 3.2.1 用户属性
- **基础信息**: 用户名、密码、邮箱、手机号、状态
- **组织信息**: 所属部门（可多选）、默认部门
- **角色信息**: 关联角色（可多选）
- **安全信息**: 密码修改时间、登录失败次数、锁定时间

#### 3.2.2 用户状态
- **正常**: 可正常登录和操作
- **锁定**: 登录失败次数超限，自动解锁或管理员解锁
- **禁用**: 管理员手动禁用，不可登录

#### 3.2.3 用户操作
**创建用户**:
- 必填：用户名、密码、角色
- 可选：邮箱、手机号、部门
- 默认状态：正常

**编辑用户**:
- 可修改：基本信息、部门、角色
- 密码重置：管理员可强制重置
- 状态变更：启用/禁用/解锁

**删除用户**:
- 软删除策略，保留审计记录
- 不可删除超级管理员

---

## 4. 权限管理体系

### 4.1 角色管理

#### 4.1.1 角色属性
- **基础信息**: 角色名称、角色编码、描述、状态
- **菜单权限**: 可访问的菜单和操作按钮
- **数据权限**: 可查看和操作的数据范围

#### 4.1.2 角色类型
1. **超级管理员**（系统内置）
   - 全部菜单权限
   - 全部数据权限
   - 不可删除、不可禁用

2. **部门管理员**（可配置）
   - 指定菜单权限（如：部门管理、CI查看等）
   - 数据权限：本部门及子部门数据

3. **普通用户**（可配置）
   - 有限的菜单权限
   - 数据权限：仅自己创建的数据或指定部门数据

#### 4.1.3 权限配置

**菜单权限（树形结构）**:
```
系统管理
├── 用户管理 [查看|创建|编辑|删除|重置密码]
├── 部门管理 [查看|创建|编辑|删除]
├── 角色管理 [查看|创建|编辑|删除|配置权限]
├── 系统配置 [查看|编辑]
└── 日志审计 [查看|导出]

CMDB
├── 模型管理 [查看|创建|编辑|删除|设计]
├── 配置仓库 [查看|创建|编辑|删除|导入|导出]
└── 全文搜索 [搜索]
```

**数据权限配置**:
- **全部数据**: 查看所有CI
- **部门及子部门**: 查看本部门及下级部门CI
- **仅本部门**: 只查看本部门CI
- **仅自己**: 只查看自己创建的CI

#### 4.1.4 角色分配
- 一个用户可拥有多个角色
- 权限取并集（只要有任一角色拥有权限，用户即拥有）
- 数据权限取最宽松的原则

### 4.2 权限验证逻辑

#### 4.2.1 菜单权限验证
- **前端**: 路由守卫检查，无权限跳转403页面或隐藏菜单
- **后端**: 每个API接口校验当前用户权限

#### 4.2.2 按钮权限验证
- **前端**: 通过指令控制按钮显示/隐藏
- **后端**: 操作前二次校验，防止绕过前端

#### 4.2.3 数据权限验证
**查询时过滤**:
- 根据用户数据权限范围，自动添加查询条件
- 超级管理员：无过滤
- 部门管理员：添加部门ID过滤
- 普通用户：添加创建人过滤

**操作时校验**:
- 编辑/删除前检查是否有权限操作该数据
- 无权限返回403错误

---

## 5. 配置仓库(CMDB)

### 5.1 数据模型

#### 5.1.1 模型与CI关系
- **模型(Model)**: 数据表结构定义，包含字段、布局等信息
- **CI(Configuration Item)**: 实际的数据实例，按模型定义存储属性值
- 一个模型对应多个CI，类似一张表的多行数据

#### 5.1.2 CI属性
- **固定字段**: ID、编码、名称、模型ID、部门ID、创建人、创建时间、更新时间
- **动态属性**: 根据模型字段定义存储，使用JSON格式
- **唯一标识**: 16位BASE编码，全局唯一

### 5.2 CI编码规则

#### 5.2.1 编码格式
- **格式**: 16位BASE编码
- **组成**: CI前缀(2位) + 时间戳(10位) + 随机数(4位)
- **示例**: CI240215A1B2C3D4E
- **字符集**: 大写字母A-Z + 数字0-9

#### 5.2.2 编码生成时机
- **时机**: 用户点击"新增CI"按钮时立即生成
- **策略**: 预生成编码，防止并发冲突
- **处理**: 如用户取消创建，编码作废（定期清理或重复使用）

### 5.3 字段类型支持

#### 5.3.1 基础字段
| 字段类型 | 说明 | 特殊要求 |
|---------|------|---------|
| text | 单行文本 | 支持长度限制 |
| number | 数字 | 支持整数/小数、范围限制 |
| boolean | 布尔值 | 是/否选择 |
| password | 密码 | 加密存储，显示为掩码 |

#### 5.3.2 选择类字段
| 字段类型 | 说明 | 特殊要求 |
|---------|------|---------|
| select | 单选 | 静态选项配置 |
| multiselect | 多选 | 支持多值存储 |
| dropdown | 下拉选择 | 支持下拉搜索 |
| cascade | 级联选择 | 支持2-3级联动，可动态加载选项 |

#### 5.3.3 引用类字段
| 字段类型 | 说明 | 特殊要求 |
|---------|------|---------|
| reference | 引用其他CI | 下拉选择，显示关联CI名称 |

#### 5.3.4 文件类字段
| 字段类型 | 说明 | 特殊要求 |
|---------|------|---------|
| file | 文件上传 | 支持下载、删除，本地存储 |
| image | 图片上传 | 支持预览、缩略图展示 |

#### 5.3.5 富文本字段
| 字段类型 | 说明 | 特殊要求 |
|---------|------|---------|
| richtext | 富文本 | 支持格式化编辑 |

#### 5.3.6 时间字段
| 字段类型 | 说明 | 特殊要求 |
|---------|------|---------|
| date | 日期 | 格式：YYYY-MM-DD |
| datetime | 日期时间 | 格式：YYYY-MM-DD HH:mm:ss |

#### 5.3.7 验证类字段
| 字段类型 | 说明 | 特殊要求 |
|---------|------|---------|
| ip | IP地址 | 格式验证（IPv4/IPv6）|
| url | URL链接 | 格式验证，支持点击跳转 |

### 5.4 CI列表页
#### 5.4.1 页面布局
**三栏式布局**:
- **左侧**: 模型目录树，点击切换右侧CI数据
- **右上**: 搜索筛选区、工具栏
- **右下**: CI数据展示区（表格或卡片）
#### 5.4.2 模型切换
- 左侧树点击模型节点，右侧展示该模型的CI列表
- 默认展示第一个模型的CI
- 支持按分类筛选模型
- 左侧树模型节点当前改模型的总数。例如 数据库（10）。
#### 5.4.3 视图模式
**表格视图**（默认）:
- 列展示：固定列（编码、名称、创建时间、操作）+ 动态列（模型前3个字段）
- 行选择：支持Checkbox多选
- 排序：支持按列排序
- 分页：每页10/20/50/100条可选

**卡片视图**:
- 每卡片展示一个CI
- 显示：图标、名称、关键属性、状态
- 悬浮显示操作按钮

**视图切换**:
- 工具栏按钮切换表格/卡片视图
- 用户偏好保存在localStorage

#### 5.4.4 列自定义
- **列设置按钮**: 打开弹窗勾选要显示的字段
- **拖拽排序**: 支持调整列顺序
- **保存方式**: localStorage存储（按模型区分）
- **默认列**: 编码、名称、创建时间、操作

#### 5.4.5 搜索筛选
**快捷搜索**:
- 搜索框：支持按CI编码、名称模糊搜索
- 快捷筛选：状态、创建时间范围

**高级筛选**:
- 展开面板，按模型字段筛选
- 支持多条件组合
- 支持重置筛选条件

#### 5.4.6 工具栏
- **新增CI**: 根据当前选中模型打开创建弹窗
- **导入**: 上传Excel批量导入
- **导出**: 导出当前筛选结果的Excel
- **批量操作**: 选择多行后显示批量编辑/删除按钮
- **刷新**: 刷新当前列表

#### 5.4.7 行操作
- **查看**: 打开详情抽屉/弹窗
- **编辑**: 打开编辑弹窗
- **删除**: 删除确认后删除
- **复制**: 复制当前CI数据，生成新编码

### 5.5 CI编辑页

#### 5.5.1 表单渲染
- **动态表单**: 根据模型字段定义自动生成表单
- **分组展示**: 按模型区域（Region）分组展示字段
- **布局适配**: 根据配置显示1列或2列布局

#### 5.5.2 字段渲染规则
- 必填字段标记红色星号
- 字段校验：按模型配置的验证规则实时校验
- 默认值：自动填充模型配置的默认值
- 联动逻辑：级联字段选择上级后动态加载下级选项

#### 5.5.3 操作按钮
- **保存**: 校验通过后保存
- **取消**: 关闭弹窗，放弃修改
- **查看历史**: 打开该CI的变更历史弹窗

### 5.6 CI详情页

#### 5.6.1 展示内容
- **基本信息**: 编码、名称、模型、部门、创建信息等
- **属性信息**: 按区域分组展示所有属性值
- **变更历史**: Tab页展示变更记录

#### 5.6.2 操作功能
- **编辑**: 跳转到编辑页面
- **删除**: 删除该CI
- **打印**: 打印CI信息

### 5.7 批量操作

#### 5.7.1 批量选择
- 表格行Checkbox选择
- 顶部显示"已选择X项"提示条
- 不支持跨页全选

#### 5.7.2 批量编辑
- 选择多行后，点击"批量编辑"
- 弹窗选择要修改的字段
- 输入新值，应用到所有选中CI
- 校验：检查是否有编辑权限

#### 5.7.3 批量删除
- 选择多行后，点击"批量删除"
- 确认弹窗显示"确定删除选中的X个CI吗？"
- 删除后刷新列表

#### 5.7.4 导入导出
**导入**:
- 下载导入模板（按当前模型生成）
- 上传Excel文件
- 预览数据，显示校验错误
- 确认导入，生成导入报告

**导出**:
- 导出当前筛选结果
- 可选导出字段
- 支持Excel格式

### 5.8 全文搜索

#### 5.8.1 搜索入口
- 独立页面：/cmdb/search
- 导航菜单：CMDB > 全文搜索

#### 5.8.2 搜索功能
- **搜索框**: 输入关键词（CI编码、名称、属性值）
- **筛选条件**: 按模型、部门、创建时间范围筛选
- **搜索结果**: 
  - 显示CI编码、名称、模型类型、匹配内容摘要
  - 点击跳转到CI详情
  - 高亮显示匹配关键词

#### 5.8.3 搜索范围
- 搜索有权限查看的所有CI
- 包含已删除CI（如需要）
- 支持属性值全文检索

### 5.9 变更历史

#### 5.9.1 记录内容
- **操作信息**: 操作类型（创建/更新/删除）、操作时间、操作人
- **变更详情**: 属性名称、变更前值、变更后值
- **环境信息**: IP地址

#### 5.9.2 查看方式
- **CI详情页**: Tab页查看该CI的历史记录
- **独立页面**: 可按时间、用户、CI筛选查看
- **列表展示**: 时间倒序，分页展示

#### 5.9.3 搜索功能
- 按操作人筛选
- 按操作类型筛选
- 按属性名称筛选
- 按时间范围筛选

### 5.10 模型变更处理

#### 5.10.1 模型字段变更
- **添加字段**: 已有CI该字段为空，新增CI按新规则处理
- **删除字段**: 已有CI保留该字段值，但不显示在新表单中
- **修改字段**: 已有CI保留原值，变更历史保留完整记录

#### 5.10.2 模型删除限制
- **校验逻辑**: 删除模型前检查是否有关联CI
- **处理规则**: 有CI数据时禁止删除模型，给出明确提示"该模型下存在X个CI实例，无法删除"

---

## 6. 业务规则说明

### 6.1 编码生成规则

#### 6.1.1 CI编码
- **格式**: 16位BASE编码
- **组成**: CI + 时间戳(10位) + 随机字符(4位)
- **字符集**: 大写字母A-Z + 数字0-9
- **唯一性**: 全局唯一，数据库唯一索引约束
- **生成时机**: 点击"新增CI"时立即生成
- **并发处理**: 使用数据库序号表或分布式锁防止重复

### 6.2 数据删除策略

#### 6.2.1 用户删除
- **策略**: 软删除
- **处理**: 标记deleted_at字段，保留数据用于审计
- **限制**: 不可删除超级管理员账户

#### 6.2.2 CI删除
- **策略**: 硬删除
- **处理**: 物理删除CI数据，但保留变更历史记录
- **权限**: 仅管理员或有删除权限的用户可操作

#### 6.2.3 部门删除
- **前置校验**: 无子部门、无关联用户
- **失败提示**: 明确告知无法删除的原因

#### 6.2.4 角色删除
- **前置校验**: 无关联用户
- **保护**: 系统内置角色不可删除

#### 6.2.5 模型删除
- **前置校验**: 无关联CI实例
- **失败提示**: "该模型下存在X个CI实例，无法删除"

### 6.3 数据关联规则

#### 6.3.1 用户与部门
- 多对多关系
- 用户必须有所属部门（至少一个）
- 可设置默认部门
- 部门负责人可查看部门数据

#### 6.3.2 用户与角色
- 多对多关系
- 用户至少有一个角色
- 角色权限取并集

#### 6.3.3 CI与部门
- 每个CI归属一个部门
- 部门数据权限控制访问范围
- 支持部门间数据共享（可选）

### 6.4 并发控制

#### 6.4.1 编码生成
- 使用数据库行锁或序号表保证唯一性
- 预生成机制，用户取消时回收编码

#### 6.4.2 数据编辑
- 乐观锁机制（版本号）
- 编辑时提示"数据已被他人修改"

---

## 7. 数据权限控制

### 7.1 权限层级

#### 7.1.1 超级管理员
- **数据范围**: 全部数据
- **操作权限**: 所有操作
- **特殊权限**: 系统配置、角色管理

#### 7.1.2 部门管理员
- **数据范围**: 本部门及子部门数据
- **操作权限**: 根据菜单权限配置
- **特殊权限**: 管理部门用户、查看部门CI

#### 7.1.3 普通用户
- **数据范围**: 
  - 方案A：仅自己创建的CI
  - 方案B：本部门CI
  - 方案C：指定范围的CI
- **操作权限**: 根据角色菜单权限

### 7.2 权限继承

#### 7.2.1 部门层级继承
- 父部门负责人可查看子部门数据（可配置）
- 子部门数据向上汇总（统计报表场景）

#### 7.2.2 角色权限继承
- 暂不支持角色继承
- 通过分配多个角色实现权限组合

### 7.3 权限验证流程

#### 7.3.1 查询场景
1. 用户发起查询请求
2. 后端获取用户角色和数据权限配置
3. 根据权限范围构建查询条件
4. 执行查询并返回结果

#### 7.3.2 操作场景
1. 用户发起编辑/删除请求
2. 后端验证用户是否有该操作的菜单权限
3. 后端验证用户是否有该数据的数据权限
4. 通过则执行操作，否则返回403

---

## 8. 附录

### 8.1 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| CI | Configuration Item | 配置项，即IT资产管理中的具体实例 |
| CMDB | Configuration Management Database | 配置管理数据库 |
| 模型 | Model | 数据结构的定义，包含字段、布局等 |
| 属性 | Attribute | CI的具体属性字段 |
| 权限 | Permission | 对功能或数据的访问控制 |
| 角色 | Role | 权限的集合，可分配给用户 |

### 8.2 默认值设置

#### 8.2.1 系统初始化
- 默认创建超级管理员账号：admin / admin
- 默认创建基础角色：超级管理员、部门管理员、普通用户
- 默认创建根部门：总公司/技术部（可选）

#### 8.2.2 配置项默认值
- Access Token有效期：30分钟
- Refresh Token有效期：7天
- 密码最小长度：8位
- 密码强制修改周期：90天
- 最大登录失败次数：5次
- 锁定时间：24小时
- 日志保留天数：30天

### 8.3 界面原型参考

#### 8.3.1 部门管理
- 左侧：部门树（可拖拽排序）
- 右侧：部门详情+用户列表
- 操作：添加子部门、编辑、删除、批量关联用户

#### 8.3.2 角色管理
- 列表页：角色表格
- 编辑页：基本信息+权限树（菜单权限+数据权限）
- 分配用户：用户选择弹窗

#### 8.3.3 CI配置仓库
- 列表页：模型树+CI表格/卡片
- 编辑页：动态表单弹窗
- 详情页：抽屉展示+历史Tab
- 搜索页：全局搜索+结果列表

### 8.4 异常处理

#### 8.4.1 权限不足
- 前端：按钮隐藏或禁用，无权限菜单不显示
- 后端：返回403状态码，错误信息"无权限执行此操作"

#### 8.4.2 数据不存在
- 返回404状态码
- 前端跳转404页面或显示"数据不存在"

#### 8.4.3 校验失败
- 返回400状态码
- 返回具体字段校验错误信息
- 前端高亮显示错误字段

#### 8.4.4 系统错误
- 返回500状态码
- 记录错误日志
- 前端显示"系统错误，请稍后重试"

---

## 文档修订记录

| 版本 | 日期 | 修订人 | 修订内容 |
|------|------|--------|---------|
| v1.0 | 2024 | - | 初始版本，包含部门管理、角色管理、CI配置仓库完整需求 |

---

**文档结束**
