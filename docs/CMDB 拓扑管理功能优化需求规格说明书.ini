CMDB 拓扑管理功能优化需求规格说明书
1. 项目背景与目标
核心痛点： 现有 CMDB 拓扑展示混乱，节点过多缺乏层级，无法有效理清资源关系；不同角色（运维/研发）需要不同的视图，目前无法隔离。
建设目标：
治理数据乱象： 通过层级、分组和聚合，将散乱的资源结构化展示。
实现视图分权： 支持动态定义视图，并按角色进行权限控制。
提升运维效率： 提供未分配资源治理、全局搜索和快速钻取能力。
2. 详细功能需求
第一部分：核心层级与展示 (Hierarchy & Visualization)
需求 1：物理层级树 (Location Tree)
定义： 基于物理位置和部署架构生成的拓扑层级。
默认层级结构： 数据中心 (DC) -> 机房/区域 (Zone) -> 机柜 (Rack) -> 物理机 (Host) -> 虚拟机/容器 (Instance)。
价值： 解决“这台机器物理位置在哪里”的问题，辅助基础设施运维。
需求 2：业务层级树 (Service Tree)
定义： 基于业务调用和归属关系生成的拓扑层级。
默认层级结构： 业务线 (Business Unit) -> 应用系统 (App) -> 应用模块 (Service) -> 实例资源 (Instance)。
价值： 解决“这台机器归谁用、影响哪个业务”的问题，辅助应用运维。
需求 3：分组容器框 (Grouping Box)
功能： 拓扑图中，属于同一父节点（如同一机柜、同一子网）的资源，必须被一个可视化的矩形容器框包裹。
交互： 容器框支持标题显示（如“机柜 A01”），并支持收起/展开。
效果： 将散乱的节点视觉化为整齐的区块，避免视觉干扰。
需求 4：智能聚合 (Smart Aggregation)
功能： 当容器框内的节点数量超过设定阈值（默认 10 个），系统自动将其折叠为一个聚合图标。
展示： 图标上需显示数量（如“服务器 x 20”）。
交互优化：
点击聚合图标，不建议直接在图上炸开所有节点（防止卡顿）。
建议： 弹出一个列表浮层 (List View)，以表格形式展示这 20 台机器的详情，支持在列表中搜索和定位。
第二部分：交互与导航 (Interaction & Navigation)
需求 5：下钻/钻取 (Drill-down)
默认状态： 进入视图时，默认只显示顶层节点（如只显示 3 个数据中心），隐藏内部细节。
交互逻辑： 双击某节点（如“北京数据中心”），画布清空或聚焦，进入下一层级，只渲染该节点内部的资源（机房级）。
需求 6：面包屑导航 (Breadcrumbs)
位置： 视图顶部常驻显示。
功能： 实时显示当前的钻取路径，例如：全网总览 > 北京数据中心 > 机房 A。
交互： 点击路径上的任意节点，可快速返回至该层级视图。
需求 7：全局搜索与定位 (Global Search)
功能： 提供全局搜索框，支持输入 IP、主机名、应用名。
逻辑：
搜索结果点击后，系统自动跳转到对应视图。
自动展开该节点所在的层级路径，并高亮/闪烁该节点，帮助用户在深层结构中快速找到目标。
第三部分：数据治理 (Data Governance)
需求 8：未分配资源池 (The "Unassigned" Sidebar)
界面： 拓扑编辑模式下，屏幕左侧提供一个侧边栏。
内容： 自动列出所有“无归属关系”（即 Parent_ID 为空）的孤立资源（如新采集的云主机）。
核心交互（拖拽即变更）：
允许用户将左侧资源拖拽至右侧画布的某个“分组框”内。
后端逻辑： 拖拽释放后，系统弹出确认框，确认后自动更新数据库，建立父子关联关系（数据清洗）。
第四部分：视图管理与权限 (View Management & RBAC)
需求 9：自定义视图创建 (View Builder)
支持管理员创建不同类型的视图，满足不同场景：

A. 动态规则视图 (Dynamic Rule-based) —— 核心推荐
定义方式： 基于属性过滤规则自动生成。
规则示例： Region = 'Beijing' 或 Business_Line = '电商业务'。
自动化： 新入库资源若满足规则，自动进入该视图，无需人工维护。
B. 静态集合视图 (Static Collection)
定义方式： 手动拖拽特定 CI 节点摆放（用于汇报大屏）。
需求 10：自定义层级模型 (Custom Hierarchy Models)
功能： 在创建视图时，允许定义该视图的层级深度和节点类型。
灵活性：
标准模式：应用 -> 实例
精细模式：应用 -> 中间件集群 -> 数据库实例 -> 物理机
说明：通过配置让不同的视图展示不同的颗粒度。
需求 11：视图授权与RBAC (Permission Control)
视图权限矩阵： 支持将“视图”绑定给“角色”。
机房运维角色： 仅可见 [物理拓扑视图]、[机房视图]。
业务研发角色： 仅可见 [应用依赖视图]、[交易系统视图]。
默认视图： 用户登录后，根据角色自动加载配置好的默认首页视图。
3. 非功能性需求 (NFR)
性能要求： 单个视图在聚合模式下，需支持渲染 1000+ 节点不卡顿（依靠聚合和懒加载实现）。
数据一致性： 拖拽治理（需求8）引发的数据变更，需实时同步至 CMDB 核心数据库。
建议实施优先级：

P0: 需求 1, 2, 3, 5, 9 (A类) —— 先把层级树建起来，解决“乱”的问题。
P1: 需求 8, 11 —— 解决“脏数据治理”和“权限隔离”问题。
P2: 需求 4, 6, 7 —— 优化体验，增加搜索、聚合和面包屑。

4. 补充约束（评审后固化，编码必须遵守）
4.1 层级映射约束
- 物理层级树、业务层级树必须基于“层级映射配置表”构建，不允许在代码中硬编码字段名。
- 层级映射配置至少包含：层级名、数据来源类型（CI属性/CI关系）、字段编码或关系类型编码、排序。

4.2 未分配资源判定口径
- “未分配资源”统一定义为：在指定层级关系类型下无父关系的 CI。
- 禁止同时引入多套事实源（如关系表 + 独立 Parent_ID 双写）；以 CMDB 关系事实为唯一真源。

4.3 搜索跳转口径
- 当搜索结果命中多个视图时，按以下优先级选择跳转视图：
  用户显式默认视图 > 当前视图 > 角色优先级最高视图 > 系统默认视图。
- 搜索定位接口必须返回完整定位路径（视图ID、层级路径、目标节点ID）。

4.4 权限粒度口径
- 视图权限至少拆分为：
  1) view（查看）
  2) layout_edit（布局编辑）
  3) governance_edit（治理拖拽）
- 无编辑权限用户不可进入编辑模式，且不可触发拖拽治理写库。

4.5 性能验收口径（客户端）
- 数据规模：单视图聚合模式下 1000+ 节点。
- 验收指标：
  1) 首屏可交互时间 <= 2 秒
  2) 常规交互（缩放/拖拽）FPS >= 30
  3) 下钻加载时延 <= 1 秒

4.6 聚合统计口径
- 聚合触发按“容器内同类型节点分桶计数”执行。
- 聚合展示格式：`节点类型 x 数量`（例如 `服务器 x 20`）。
- 点击聚合项默认打开列表浮层，不在画布上一次性炸开全部节点。
